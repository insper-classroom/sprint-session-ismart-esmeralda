<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Conversa Management</title>
</head>
<body>
    <ul>
        <div class="conversa" id="conversa-notassigned">
        {% for conversa in notassigned %}
            <li>
                <form method="POST" action="assign_conversa/{{ conversa.id }}/">                    
                    {% csrf_token %}
                    <button type="submit">Assign to me</button>
                </form>
                <form method="POST" action="resolve/{{ conversa.id }}/">
                    {% csrf_token %}
                    <input type="submit" value="Resolver conversa">
                </form>
                <form method="POST" action="sendmsg/{{ conversa.usuarios.telefone }}/{{ conversa.id }}/">
                    {% csrf_token %}
                    <textarea name="mensagem" placeholder="Digite sua mensagem"></textarea>
                    <input type="submit" value="Enviar mensagem">
                </form>
                <strong>NOT ASSIGNED {{ conversa.id }}</strong> with {{ conversa.usuarios.username }}
                <ul>
                    {% if conversa.mensagens.exists %}
                        {% for mensagem in conversa.mensagens.all %}
                            <li>{{ mensagem.sender }}: {{ mensagem.content }}</li>
                        {% endfor %}
                    {% elif conversa.mails.exists %}
                        {% for mensagem in conversa.mails.all %}
                            <li>{{ mensagem.sender }}: {{ mensagem.subject }}; {{ mensagem.content }}</li>
                        {% endfor %}
                    {% endif %}
                </ul>
            </li>
        {% endfor %}
        </div>
    </ul>
    
    <ul>
        <div class="conversa" id="conversa-yours">
        {% for conversa in yours %}
            <li>
                <form method="POST" action="sendmsg/{{ conversa.usuarios.telefone }}/{{ conversa.id }}/">
                    {% csrf_token %}
                    <textarea name="mensagem" placeholder="Digite sua mensagem"></textarea>
                    <input type="submit" value="Enviar mensagem">
                </form>
                <form method="POST" action="resolve/{{ conversa.id }}/">
                    {% csrf_token %}
                    <input type="submit" value="Resolver conversa">
                </form>
                <strong>YOURS {{ conversa.id }}</strong> with {{ conversa.usuarios.username }}
                <ul>
                    {% if conversa.mensagens.exists %}
                        {% for mensagem in conversa.mensagens.all %}
                            <li>{{ mensagem.sender }}: {{ mensagem.content }}</li>
                        {% endfor %}
                    {% elif conversa.mails.exists %}
                        {% for mensagem in conversa.mails.all %}
                        <li><strong>Assunto: {{mensagem.subject}}</strong><br>
                            {{ mensagem.content }}
                        </li>
                        {% endfor %}
                    {% endif %}
                </ul>
            </li>
        {% endfor %}
        </div>
    </ul>
    
    <ul>
        <div class="conversa" id="conversa-resolved">
        {% for conversa in resolved %}
            <li>
                <strong>RESOLVED {{ conversa.id }}</strong> with {{ conversa.usuarios.username }}
                <ul>
                    {% for mensagem in conversa.mensagens.all %}
                        <li>{{ mensagem.sender }}: {{ mensagem.content }}</li>
                    {% endfor %}
                </ul>
            </li>
        {% endfor %}
        </div>
    </ul>
</body>
</html>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    var requestCount = 0;  // Initialize a counter

    function updateDiv() { 
        $("#conversa").load(window.location.href + " #conversa");
        requestCount++;  // Increment the counter
        console.log("Number of requests made: " + requestCount);  // Log the current count
    }

    $(document).ready(function() {
        TimeOut(updateDiv, 3500);  // Call updateDiv every 4 seconds
    });  
</script>
</html>
   
</html>